name: Release

on:
  workflow_call:
    inputs:
      language:
        description: 'Programming language (go or python)'
        required: true
        type: string
      docker:
        description: 'Build and push to GHCR'
        required: false
        type: boolean
        default: false
      brew:
        description: 'Update Homebrew tap'
        required: false
        type: boolean
        default: true
      krew:
        description: 'Update Krew index'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  test:
    uses: ./.github/workflows/test.yml
    with:
      language: ${{ inputs.language }}

  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        if: inputs.language == 'go'
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install GoReleaser
        if: inputs.language == 'go'
        uses: goreleaser/goreleaser-action@v6
        with:
          install-only: true

      - name: Set up Python (uv)
        if: inputs.language == 'python'
        uses: astral-sh/setup-uv@v7

      - name: Build release
        run: make release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GHCR
        if: inputs.docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: inputs.docker
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            VERSION=${{ github.ref_name }}
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest

      - name: Update Homebrew tap
        if: inputs.brew
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: ${{ github.event.repository.name }}
          homebrew-tap: ${{ github.repository_owner }}/homebrew-${{ github.repository_owner }}
          tag-name: ${{ github.ref_name }}
          download-url: https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz
          create-pullrequest: false
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}

      - name: Update Krew index
        if: inputs.krew
        uses: rajatjindal/krew-release-bot@v0.0.47
