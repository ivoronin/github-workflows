name: Release

on:
  workflow_call:
    inputs:
      language:
        description: 'Programming language (go, python, or swift)'
        required: true
        type: string
      docker:
        description: 'Build and push to GHCR'
        required: false
        type: boolean
        default: false
      brew:
        description: 'Update Homebrew tap'
        required: false
        type: boolean
        default: true
      krew:
        description: 'Update Krew index'
        required: false
        type: boolean
        default: false
      gpg:
        description: 'Import GPG key and sign release artifacts'
        required: false
        type: boolean
        default: false
      runner:
        description: 'Override runner image (default: macos-latest for swift, ubuntu-latest otherwise)'
        required: false
        type: string
    secrets:
      GPG_PRIVATE_KEY:
        required: false
      PASSPHRASE:
        required: false

permissions:
  contents: write
  packages: write

jobs:
  test:
    uses: ./.github/workflows/test.yml
    with:
      language: ${{ inputs.language }}
      runner: ${{ inputs.runner }}

  release:
    needs: test
    runs-on: ${{ inputs.runner || (inputs.language == 'swift' && 'macos-latest' || 'ubuntu-latest') }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        id: go
        if: inputs.language == 'go'
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install GoReleaser
        if: inputs.language == 'go'
        uses: goreleaser/goreleaser-action@v7
        with:
          install-only: true

      - name: Set up Python (uv)
        if: inputs.language == 'python'
        uses: astral-sh/setup-uv@v7

      - name: Import GPG key
        id: gpg
        if: inputs.gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}

      - name: Build release
        run: make release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.gpg.outputs.fingerprint }}

      - name: Create GitHub Release
        if: inputs.language == 'swift'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*

      - name: Login to GHCR
        if: inputs.docker
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: inputs.docker
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            GO_VERSION=${{ steps.go.outputs.go-version }}
            VERSION=${{ github.ref_name }}
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest

      - name: Update Homebrew tap
        if: inputs.brew
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: ${{ github.event.repository.name }}
          homebrew-tap: ${{ github.repository_owner }}/homebrew-${{ github.repository_owner }}
          tag-name: ${{ github.ref_name }}
          download-url: https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz
          create-pullrequest: false
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}

      - name: Update Krew index
        if: inputs.krew
        uses: rajatjindal/krew-release-bot@v0.0.47
